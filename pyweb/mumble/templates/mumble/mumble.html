{% extends "index.html" %}
{% comment %}
    <!-- kate: space-indent on; indent-width 4; replace-tabs on; -->
{% endcomment %}
{% load mumble_extras %}
{% load i18n %}
{% block body %}{% endblock %}
{% block HeadTag %}
    <script type="text/javascript" src="/jsi18n/"></script>
    <script type="text/javascript" src="/mumble/api/api.js"></script>
    <script type="text/javascript" src="/mumble/forms/api.js"></script>
    <script type="text/javascript" src="/mumble/forms/{{ RegForm|lower }}.js"></script>
    <script type="text/javascript" src="/mumble/forms/mumbleform.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/channelviewer.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/usereditor.js"></script>
    <script type="text/javascript">
        Ext.ux.IFrameComponent = Ext.extend(Ext.BoxComponent, {
            // http://www.extjs.com/forum/showthread.php?p=54416#post54416
            onRender : function(ct, position){
                this.el = ct.createChild({tag: 'iframe', id: 'iframe-'+ this.id, frameBorder: 0, src: this.url});
            }
        });

        Ext.onReady( function(){
            Ext.QuickTips.init();
            viewsize = {
                width:  Ext.lib.Dom.getViewWidth(),
                height: Ext.lib.Dom.getViewHeight()
            };
            var mainpanel = new Ext.Panel({
                renderTo: document.body,
                height:   viewsize.height,
                layout:   "border",
                title:    "{{ MumbleServer.name }}",
                buttons: [ 
                    {% if user.is_staff %}{
                        text: gettext('Admin'),
                        enableToggle: true,
                        toggleHandler: function(button, state){
                            if( !this.wnd ){
                                this.wnd = new Ext.Window({
                                    title: gettext('Administration'),
                                    layout: 'fit',
                                    items: new Ext.ux.IFrameComponent({ url: '/admin' }),
                                    width:  viewsize.width - 200,
                                    height: viewsize.height - 100,
                                    buttons: [{
                                        text: gettext('Open in new window'),
                                        handler: function(){
                                            window.open( '/admin' );
                                            this.ownerCt.ownerCt.ownerButton.toggle( false );
                                        }
                                    }],
                                    listeners: {
                                        beforeclose: function(){
                                            this.ownerButton.toggle( false, false );
                                            this.ownerButton.wnd = null;
                                        }
                                    },
                                });
                                this.wnd.ownerButton = this;
                            }
                            if( state ){
                                this.wnd.show();
                                mypos = this.getPosition();
                                mysize = this.getSize();
                                winsize = this.wnd.getSize();
                                this.wnd.setPosition(
                                    mypos[0] + mysize.width - winsize.width,
                                    mypos[1] - winsize.height
                                    );
                            }
                            else
                                this.wnd.hide();
                        },
                    }, {% endif %}
                    {% if user.is_authenticated %}{
                        text: gettext('Logout'),
                        handler: function(){
                            Accounts.logout( function(provider, response){
                                    if( response.result.success ){
                                        window.location.reload();
                                    }
                                    else{
                                        Ext.Msg.show({
                                            title: gettext("Login error"),
                                            msg:   gettext("Unable to log out."),
                                            icon:  Ext.MessageBox.ERROR,
                                            buttons: Ext.MessageBox.OK
                                            });
                                    }
                                } );
                        }
                    } {% else %} {
                        text: gettext('Login'),
                        enableToggle: true,
                        toggleHandler: function(button, state){
                            if( !this.wnd ){
                                this.wnd = new Ext.Window({
                                    title: gettext('Login'),
                                    closable: false,
                                    width:  300,
                                    height: 130,
                                    layout: 'fit',
                                    items: {
                                        layout: 'form',
                                        border: false,
                                        defaults: { anchor: '-20px' },
                                        buttons: [{
                                            text: gettext('Submit'),
                                            handler: function(){
                                                form = this.ownerCt.ownerCt.items.items;
                                                Accounts.login(form[0].getValue(), form[1].getValue(),
                                                    function(provider, response){
                                                        if( response.result.success ){
                                                            window.location.reload();
                                                        }
                                                        else{
                                                            Ext.Msg.show({
                                                                title: gettext("Login error"),
                                                                msg:   gettext("Unable to log in."),
                                                                icon:  Ext.MessageBox.ERROR,
                                                                buttons: Ext.MessageBox.OK
                                                                });
                                                        }
                                                    });
                                            }
                                        }],
                                        items: [{
                                            xtype: "textfield",
                                            width: 50,       
                                            fieldLabel: gettext("User name"),
                                            name: "username"
                                        }, {
                                            xtype: 'textfield',
                                            fieldLabel: gettext("Password"),
                                            inputType: "password",
                                            name: "password"
                                        }],
                                    },
                                });
                            }
                            if( state ){
                                this.wnd.show();
                                mypos = this.getPosition();
                                mysize = this.getSize();
                                winsize = this.wnd.getSize();
                                this.wnd.setPosition(
                                    mypos[0] + mysize.width - winsize.width,
                                    mypos[1] - winsize.height
                                    );
                            }
                            else
                                this.wnd.hide();
                        },
                    } {% endif %}
                ],
                items: [{
                    xtype: "mumblechannelviewer",
                    region: "west",
                    width: 350,
                    split: true,
                    source_url: "{% url mumble.views.cvp_json MumbleServer.id %}",
                }, {
                    xtype: "tabpanel",
                    region: "center",
                    activeTab: 0,
                    items: [{
                        title: gettext("Registration"),
                        xtype: "{{ RegForm|lower }}",
                        pk: {% if MumbleAccount %}{{ MumbleAccount.id }}{% else %}-1{% endif %},
                        labelWidth: 150,
                        submit: function(){
                            this.getForm().submit({ params: {serverid: {{MumbleServer.id}}, pk: this.pk } });
                        },
                    },
                    {% if MumbleAccount %}
                    {% if IsAdmin %} {
                        title: gettext("Administration"),
                        pk:    {{ MumbleServer.id }},
                        labelWidth: 150,
                        xtype: 'mumbleform',
                    }, {% endif %}
                    {
                        title: gettext("User texture"),
                        layout: "border",
                        items: [{
                            region: "north",
                            layout: "hbox",
                            height: 200,
                            items: [{
                                flex: 1,
                                height: 200,
                                title: gettext("Texture"),
                                html: String.format('<img src="{0}" alt="Avatar" />',
                                  "{% url mumble.views.showTexture MumbleServer.id MumbleAccount.id %}"),
                            }, {
                                flex: 1,
                                height: 200,
                                title: gettext("Gravatar"),
                                html: String.format('<img src="{0}" alt="grAvatar" />', "{{ MumbleAccount.gravatar }}"),
                            }],
                        }, {
                            region: "center",
                            xtype: "form",
                            labelWidth: 150,
                            fileUpload: true,
                            url: "{% url mumble.views.update_avatar MumbleAccount.id %}",
                            items: [{
                                name:       "usegravatar",
                                fieldLabel: gettext("Use Gravatar"),
                                xtype:      "checkbox",
                            }, {
                                name:       "texturefile",
                                fieldLabel: gettext("Upload Avatar"),
                                xtype:      "textfield",
                                inputType:  "file",
                            }],
                            buttons: [{
                                text:   gettext('Submit'),
                                handler: function(){ this.ownerCt.ownerCt.getForm().submit(); },
                            }],
                        }],
                    },
                    {% if IsAdmin %} {
                        xtype: "userEditorPanel",
                    } {% endif %}
                    {% endif %} ],
                }],
            });
        } );
    </script>
{% endblock %}
